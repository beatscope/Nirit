if(typeof(NIRIT)==="undefined"){var NIRIT={}}NIRIT.Board=function(a){this.data=a.data;this.spaces=a.spaces;this.token=a.token;this.filter=null;this.account=a.account;this.cards=[];this.more=null;this.title=document.title;this.loading=false;if(this.data.hasOwnProperty("results")){this.cards=this.data.results;this.more=this.get_next_uri(this.data.next)}if(!this.data.hasOwnProperty("results")||this.data.results.length==0){this.cards.push({subject:"There are currently no notices on this board."})}this.notices=a.notices;if(document.location.search){this.filter=document.location.search.split("=")[1]}this.view=$.cookie("notices");if(this.view){this.view=JSON.parse(this.view)}else{this.view=this.notices}$.cookie("notices",JSON.stringify(this.notices),{expires:30,path:"/"});var c=0;for(var d in this.notices){c++;for(var b in this.notices[d]){c++}}this.counters={latest:c};this.add_notices();switch(a.filter["type"]){case"space":this.space=a.filter["value"];this.listen();break;case"supplier":this.mention=a.filter["value"];break}};NIRIT.Board.prototype.get_next_uri=function(a){if(!a){return null}var b="/api/notices?"+a.split("?")[1];return b};NIRIT.Board.prototype.listen=function(){var a=this;setInterval(function(){$.ajax({url:"/api/notices?space="+a.space,type:"OPTIONS",contentType:"application/json; charset=UTF-8",dataType:"json",success:function(c){var b=c.results["all"]-a.counters.latest;if(b>0){document.title="("+b+") "+a.title;$("#latest_count").find("span").css("visibility","visible");$("#latest_count").find("span").html("("+b+")");$("#latest_count").animate({color:"#C0202F"},250).animate({color:"#393939"},500,function(){$(this).attr("style","")})}},error:function(b){},headers:{Authorization:"Token "+a.token}})},30000)};NIRIT.Board.prototype.add_notices=function(e){for(var b in this.cards){var c=this.apply_template(this.cards[b]);this.add_notice(c);c=null;if(typeof(e)!=="undefined"&&e){this.flash_card(this.cards[b].id)}}this.set_listeners();var d=$("a#plus");d.hide();if(this.more){var a=this;d.show().unbind("click").bind("click",function(){a.fetch(d);return false})}};NIRIT.Board.prototype.fetch=function(b,c){var a=this;if(!a.more){return false}b.addClass("loading");b.find("span").text("Loading more notices...");$.get(a.more,function(d){b.removeClass("loading");b.find("span").text("More");a.cards=d.results;a.more=a.get_next_uri(d.next);a.add_notices(true);if(!a.more){b.hide()}a.set_listeners();if(typeof(c)==="function"){c()}},"json")};NIRIT.Board.prototype.add_replies=function(b,c){var a=this;c.data("uri",b);c.parent().find(".plus").addClass("loading");c.parent().find(".plus").find("span").text("Loading more notices...");$.get(b,function(f){c.parent().find(".plus").removeClass("loading");c.parent().find(".plus").find("span").text("More");var g=f.results;for(var d in g){var e=a.apply_template(g[d],"reply");a.add_notice(e,c);e=null;a.flash_card(g[d].id,500)}if(f.next){c.parent().find(".plus").show().unbind("click").bind("click",function(){var h=[];h.push(c.data("uri").split("?")[0]);h.push(f.next.split("?")[1]);h=h.join("?");a.add_replies(h,c);return false})}else{c.parent().find(".plus").hide()}},"json")};NIRIT.Board.prototype.add_notice=function(a,c,b){if(typeof(c)==="undefined"||c===null){c=$("#stream")}if(typeof(b)!=="undefined"&&b==true){c.prepend(a)}else{c.append(a)}};NIRIT.Board.prototype.apply_template=function(b,j){var g=new RegExp(/\B@([-_\w]+)/g);try{var c=b.sender.full_name;if(b.sender.is_admin){c="System Administrator"}var i=b.sender.avatar;if((b.official||b.type=="INTRO")&&b.sender.company.square_logo){i=b.sender.company.square_logo}}catch(f){var c=null;var i=NIRIT.STATIC_URL+"images/nirit-icon-60x60-grey.png"}var a='<div id="card_'+b.id+'" class="card ';if(this.view){if(typeof(j)==="undefined"){if(!(b.id in this.view)){a+=" is-new"}}}a+='">';a+='<div class="category';switch(b.type){case"ALERT":a+=" alert";break;case"INTRO":a+=" official";break;case"NOTICE":default:if(b.official){a+=" official"}break}a+='"></div>';a+='<div class="avatar"><img src="'+i+'" alt="'+c+'" width="60px" height="auto" /></div>';if(typeof(j)==="undefined"){b.subject=b.subject.replace(g,'<a href="/supplier/$1">@$1</a>');a+='<div class="subject">'+b.subject+"</div>"}var d=b.hasOwnProperty("body")?b.body:false;if(d){d=d.replace(g,'<a href="/supplier/$1">@$1</a>');if(typeof(j)==="undefined"){var h=(d.length>255)?true:false;if(h){a+='<div class="body truncated">';a+='<div class="hidden full-body">'+d+"</div>";a+='<div class="truncated-body"><p>'+$(d).text().substr(0,255)+"...</p></div>";a+="</div>"}else{a+='<div class="body">'+d+"</div>"}}else{a+='<div class="body">'+d+"</div>"}}if(c){a+='<div class="age">'+b.age+" ago</div>";if(b.sender.is_admin){a+='<div class="sender">'+c+"</a>"}else{if(b.official){a+='<div class="sender"><span><a href="/company/'+b.sender.company.slug+'">'+b.sender.company.name+"</span></a>";a+=' - <a href="/member/'+b.sender.codename+'">'+c+"</a>"}else{a+='<div class="sender"><a href="/member/'+b.sender.codename+'">'+c+"</a>";a+=', <span><a href="/company/'+b.sender.company.slug+'">'+b.sender.company.name+"</a></span>"}}}a+="</div>";if(c&&b.type!="ALERT"&&!b.sender.is_admin&&typeof(j)==="undefined"){a+="<ul>";if(b.replies.length>0){if(this.view){if(b.id in this.view){if(this.view[b.id].length!=b.replies.length){a+='<li class="has-new"><span>new</span></li>'}}}a+='<li class="replies"><a href="" class="open-replies';a+='" rel="'+b.id+'">';a+=b.replies.length;a+="</a></li>"}a+='<li class="reply"><a href="" class="open-reply" rel="'+b.id+'"></a></li>';a+='<li class="star"><a href="" class="star';if($.inArray(b.id,this.account.starred)>-1){a+=' active"';a+='" title="Unflag notice"'}else{a+='" title="Flag notice"'}a+=' rel="'+b.id+'">';a+="</a></li>";a+="</ul>";a+='<div class="card-replies hidden" rel="'+b.id+'">';a+='<p class="box-title">All Replies <span class="close"></span></p>';a+='<div class="card-replies-holder"></div>';a+='<a href="" class="button plus"><span>More</span></a>';a+="</div>";a+='<div class="card-reply hidden" rel="'+b.id+'">';a+='<p class="box-title">Leave a reply <span class="close"></span></p>';a+='<textarea class="reply elastic" rows="2" cols="70"></textarea>';if($.inArray("Owner",this.account.roles)>-1||$.inArray("Rep",this.account.roles)>-1){a+='<div class="reply-as-org">';a+="<label>";a+='<input type="checkbox" class="reply-is-official" name="'+this.account.company.name+'" value="'+this.account.company.codename+'">on behalf of <strong>'+this.account.company.name+"</strong>";a+="</label>";a+="</div>"}a+='<button class="button reply">Reply</button>';a+="</div>"}a+="</div>";return a};NIRIT.Board.prototype.flash_card=function(a,c){var d=1000;if(typeof(c)!=="undefined"){d=c}var b=$("#card_"+a);b.addClass("highlight");setTimeout(function(){b.animate({backgroundColor:"#F2F2F3"},d,function(){$(this).removeClass("highlight");$(this).attr("style","")})},d)};NIRIT.Board.prototype.set_listeners=function(){var a=this;var b=2000;$(".elastic").elastic();$(".elastic").each(function(){if($(this).hasClass("no-limit")){return}var c=$("<div>");c.addClass("char_count");c.html(b);$(this).before(c);$(this).bind("keydown",function(d){if(parseInt(b-$(this).val().length)<=0&&(d.keyCode!==8&&d.keyCode!==37&&d.keyCode!==38&&d.keyCode!==39&&d.keyCode!==40)){return false}});$(this).keyup(function(){c.html(Math.max(0,b-$(this).val().length));if($(this).val().length>b){$(this).val($(this).val().substring(0,b))}})});$("#new_card").unbind("click").bind("click",function(){$("#add_card_subject").val("");$("#add_card_body").val("");if($(".card-add").is(":visible")){$(".card-add").slideUp(250)}else{$(".card-add").slideDown(250,function(){$("#add_card_subject").focus()})}return false});$(".card-add").find("span.close").unbind("click").bind("click",function(){$(".card-add").slideUp(250)});$("#add_card").unbind("click").bind("click",function(){var d=$("#add_card_subject").val();if(a.hasOwnProperty("mention")){d+=" @"+a.mention}var c=$("#add_card_body").val();var f=$("#add_is_official").is(":checked")?"on":"";var e=$("#add_is_type").find("option:selected");e=e.length>0?e.val():null;if(d.length>0){$.ajax({url:"/api/notices/post",data:JSON.stringify({subject:trim(d),body:trim(c),spaces:a.spaces,official:f,type:e}),type:"POST",contentType:"application/json; charset=UTF-8",dataType:"json",success:function(g){location.reload(true)},error:function(g){},headers:{Authorization:"Token "+a.token}})}});$(".open-reply").unbind("click").bind("click",function(){var c=$(this);$(".card-reply").each(function(){if($(this).attr("rel")==c.attr("rel")){if($(this).is(":visible")){$(this).slideUp()}else{$(this).find("textarea").val("");$(this).slideDown(250,function(){$(this).find("textarea").focus()})}}else{$(this).slideUp(250)}});return false});$(".card-reply").find("span.close").unbind("click").bind("click",function(){$(".card-reply").slideUp(250)});$(".card-reply").each(function(){var c=$(this);$(this).attr("card_id",$(this).attr("rel"));$(this).find("button").unbind("click").bind("click",function(){var e=null;for(var g in a.cards){if(a.cards[g].id==c.attr("card_id")){e=a.cards[g].subject;break}}var d=c.find("textarea").val();var f=c.find(".reply-is-official").is(":checked")?"on":"";if(e&&d.length>0){$.ajax({url:"/api/notices/post",data:JSON.stringify({subject:e,body:trim(d),spaces:a.spaces,official:f,nid:c.attr("card_id")}),type:"POST",contentType:"application/json; charset=UTF-8",dataType:"json",success:function(h){location.reload(true)},error:function(h){},headers:{Authorization:"Token "+a.token}})}})});$(".open-replies").unbind("click").bind("click",function(){var c=$(this);$(".card-replies").each(function(){var e=$(this);if(e.attr("rel")==c.attr("rel")){var d=null;$(".card-reply").each(function(){if($(this).attr("rel")==e.attr("rel")){d=$(this)}});if(e.is(":visible")){e.slideUp();d.slideUp()}else{e.find(".card-replies-holder").empty();e.slideDown(250,function(){e.find(".card-replies-holder").each(function(){var f=$(this);var g="/api/notices/"+c.attr("rel")+"/";a.add_replies(g,f)})});d.slideDown()}}else{$(this).slideUp(250)}});return false});$(".card-replies").find("span.close").unbind("click").bind("click",function(){$(".card-replies").slideUp(250)});$(".card.is-new").unbind("click").bind("click",function(){var c=$(this);c.animate({backgroundColor:"#F2F2F3"},500,function(){c.removeClass("is-new")})});$(".body.truncated").each(function(){var c=$(this);c.find(".label").remove();var d=$('<span class="label">expand</span>');d.bind("click",function(){if(c.hasClass("open")){c.find(".full-body").hide();c.find(".truncated-body").show();c.removeClass("open");d.text("expand")}else{c.find(".truncated-body").hide();c.find(".full-body").show();c.addClass("open");d.text("collapse")}});d.appendTo(c)});$("a.star").unbind("click").bind("click",function(){var c=$(this);NIRIT.utils.set_member_preference("starred",c.attr("rel"),function(d){if(c.hasClass("active")){c.removeClass("active")}else{c.addClass("active")}});return false})};